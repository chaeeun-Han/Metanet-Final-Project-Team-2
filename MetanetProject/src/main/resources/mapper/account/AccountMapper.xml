<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "../mybatis-3-mapper.dtd">

<mapper namespace="com.example.myapp.account.dao.IAccountRepository">

	<select id="getLecture" resultType="com.example.myapp.account.model.AccountLecture">
		SELECT l.title as title, l.profile as profile, l.category as category, a.is_coursable as is_coursable, l.finished as finished
		FROM lectures l
		JOIN attends a ON l.lecture_id = a.lecture_id
		WHERE a.member_id =#{memberId}
	</select>	
	
	<insert id="insertCategory">
		INSERT INTO members_tags (member_id, tag_id)
		VALUES (#{memberId}, (SELECT tag_id FROM tags WHERE tag_name = #{tagName}));
	</insert>
	
	<update id="updateProfile">
		UPDATE members
		SET profile = #{fileUrl}
		WHERE member_id = #{memberUID}
	</update>
	
	<select id="getMyPage" resultType="com.example.myapp.member.model.Member">
		SELECT * FROM members WHERE member_id = #{memberUID}
	</select>	
	
	<select id="getAllStudent" resultType="int">
		SELECT COUNT(*)
		FROM students
		WHERE lecture_list_id = #{lecutre_list_id}
	</select>
	
	<select id="getPaylog" resultType="com.example.myapp.account.model.Pay">
		SELECT p.pay_id as pay_id, p.status as status, p.price as price, l.start_date as start_date, l.end_date as end_date
		FROM attends a
		JOIN lectures l ON l.lecture_id = a.lecture_id
		JOIN pays p ON p.lecture_id = a.lecture_id
		WHERE a.member_id = #{memberUID}
	</select>
	
	<select id="getMyStudy" resultType="com.example.myapp.account.model.MyStudy">
		SELECT   
			lec.lecture_id,
		    lec.title,
		    lec.start_date,
		    lec.end_date,
		    COUNT(CASE WHEN s.is_attend = TRUE THEN 1 END) * 100 / COUNT(*) AS attendance_rate
		FROM students s
		JOIN lecture_lists l ON s.lecture_list_id = l.lecture_list_id
		JOIN members m ON s.member_id = m.member_id
		JOIN lectures lec ON l.lecture_id = lec.lecture_id 
		WHERE m.member_id = #{memberUID}
		GROUP BY m.member_id, m.name, l.lecture_id, lec.title
		ORDER BY m.member_id, l.lecture_id;
	</select>
	
	<select id="getMyStudyLectureList" resultType="com.example.myapp.account.model.MyStudy">
		SELECT l.lecture_list_id, l.title, s.is_attend, l.end_time, l.start_time, lec.lecture_id
		FROM students s
		JOIN lecture_lists l ON s.lecture_list_id = l.lecture_list_id
		JOIN lectures lec ON l.lecture_id = lec.lecture_id 
		WHERE s.member_id =#{memberUID} AND lec.lecture_id =#{lecture_id};	
	</select>
	
	
	<select id="getDueToLectures" resultType="com.example.myapp.account.model.DueToLecture">
		SELECT title, start_date, end_date
		FROM lectures 
		WHERE member_id =#{teacherId}
	</select>
	
	<select id="getIngLectures" resultType="com.example.myapp.account.model.IngLecture">
	    <![CDATA[
	    SELECT
	        lec.lecture_id,
	        ll.title AS lecture__list_title,
	        ll.start_time,
	        ll.end_time,
	        (SUM(CASE WHEN s.is_attend = TRUE THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(DISTINCT s.member_id), 0)) AS attendance_rate
	    FROM lectures lec
	    JOIN lecture_lists ll ON lec.lecture_id = ll.lecture_id
	    LEFT JOIN students s ON ll.lecture_list_id = s.lecture_list_id
	    WHERE lec.member_id = #{teacherId}
	    AND DATE(lec.start_date) <= CURDATE()
	    AND DATE(lec.end_date) >= CURDATE()
	    GROUP BY ll.lecture_list_id, lec.lecture_id, ll.title, ll.start_time, ll.end_time, lec.start_date, lec.end_date;
	    ]]>
	</select>

	
	<select id="getEndLectues" resultType="com.example.myapp.account.model.EndLecture">
	<![CDATA[
	    SELECT
	        l.title AS lecture_title,
	        l.start_date,
	        l.end_date,
	        l.lecture_id,
	        (SUM(CASE WHEN a.is_coursable = TRUE THEN 1 ELSE 0 END) * 100.0) /
	        NULLIF(COUNT(DISTINCT a.member_id), 0) AS course_percent
	    FROM lectures l
	    JOIN attends a ON l.lecture_id = a.lecture_id
	    WHERE a.member_id = #{teacherId}
	    AND DATE(l.end_date) < CURDATE()
	    GROUP BY l.lecture_id, l.title, l.start_date, l.end_date;
	]]>  
	</select>


</mapper>